#!/usr/bin/env python2
# -*- coding: utf-8 -*-

from pymongo import MongoClient
from estnltk import Text

client = MongoClient('mongodb://localhost:27017/')
db = client.bloglyzer

def generateLemmas():
	for document in db.post.find():

		lemmad = {}
		words = document.get('words');
		for word, value in words.iteritems():

			word = Text(word).lemmas[0].encode('UTF-8')

			# add with 0 if new
			if word not in lemmad:
				lemmad[word] = 0

			# add to total
			lemmad[word] += value

		result = db.post.update_one({
			'_id': document.get('_id')
		}, {
			'$set': {
				'lemmas': lemmad
			}
		})

		if result.matched_count != 1:
			print 'Failed to add lemmas'

	print 'All lemmas added'

def updateEmotionalWordsToDB():
	if 'emotionalwords' in db.collection_names():
		db.emotionalwords.remove();

	em = db['emotionalwords'];

	emwords = {
		'KIRG': 0.690133467,
		'ARMUMA': 0.665058487,
		'HIRM': 0.598133321,
		'AGRESSIIVSUS': 0.491480277,
		'JULMUS': 0.490744401,
		'JÄLESTUS': 0.434066916,
		'ARMUKADEDUS': 0.425038794,
		'ENTUSIASM': 0.393915789,
		'JOOVASTUS': 0.391055514,
		'IHA': 0.374249778,
		'KARTUS': 0.362211236,
		'KARJUMINE': 0.354004518,
		'KÕHEDUS': 0.323732402,
		'EKSTAAS': 0.314287305,
		'KURJUS': 0.307984579,
		'ELEVUS': 0.306829637,
		'KANGEKAELSUS': 0.285687901,
		'HULL': 0.282966896,
		'AHNUS': 0.279825989,
		'ELURÕÕM': 0.266582526,
		'INNUKUS': 0.260895226,
		'JULGUS': 0.248753172,
		'HINGEVALU': 0.245634431,
		'HÄDAS': 0.235926267,
		'KAHTLUS': 0.228889965,
		'HAIGLANE': 0.225579465,
		'HÄBI': 0.220747654,
		'ARMASTUS': 0.214384285,
		'AHISTATUS': 0.21378036,
		'AKTIIVSUS': 0.211083195,
		'ENERGILINE': 0.206490611,
		'KAMMITSETUD': 0.203099184,
		'KELMIKAS': 0.197726601,
		'KÜÜNILISUS': 0.196651959,
		'HALB': 0.193784156,
		'KIMBATUS': 0.187075956,
		'KÕHKLUS': 0.185309353,
		'AGAR': 0.184286362,
		'KADEDUS': 0.179448277,
		'ELAV': 0.173159353,
		'HÄIRIV': 0.169657931,
		'JULTUMUS': 0.158839575,
		'AVAMEELSUS': 0.152702677,
		'HUVI': 0.142724127,
		'KAHJURÕÕM': 0.125610783,
		'EUFOORIA': 0.112607175,
		'ERGAS': 0.107612463,
		'HULLJULGE': 0.102341302,
		'ETTEVÕTLIKKUS': 0.088429508,
		'ERUTUS': 0.087266201,
		'IMESTUS': 0.078374213,
		'AHASTUS': 0.076580424,
		'KALLISTAMINE': 0.07608754,
		'KOHKUMA': 0.075448694,
		'HÄMMASTUS': 0.0691949,
		'EBAKINDLUS': 0.0687154,
		'KITSIKUS': 0.067561712,
		'HÜLJATUD': 0.045892797,
		'EBAMEELDIVUS': 0.040076263,
		'HÄBEMATUS': 0.031398618,
		'EDEVUS': 0.02823889,
		'KIHEVIL': 0.023473159,
		'JÕULINE': 0.013226942,
		'ALANDUS': 0.008921892,
		'HAAVUNUD': 0.000792829,
		'HELLUS': 0.000791349,
		'IMETLUS': 0.000751382,
		'DEPRESSIOON': 0.000746645,
		'HEA': 0.000740428,
		'KURBUS': 0.000737171,
		'LEIN': 0.00071023,
		'KINDLUS': 0.000706086,
		'HINGERAHU': 0.000692467,
		'KAHETSUS': 0.000681809,
		'KESKENDUNUD': 0.000671743,
		'ENESEKINDLUS': 0.000667895,
		'HOOL': 0.000656941,
		'HÄDINE': 0.000655757,
		'HALEDUS': 0.000635033,
		'KÜLMUS': 0.000632072,
		'KURNATUD': 0.000625855,
		'LAHKE': 0.000625855,
		'HINGESTATUD': 0.000619046,
		'ABIVALMIDUS': 0.00061727,
		'JÕUETUS': 0.000611053,
		'ARMETU': 0.000610757,
		'ALANDLIKKUS': 0.000592401,
		'ABITUS': 0.000588257,
		'HOOLIMATUS': 0.000578191,
		'ENESEHALETSUS': 0.000532599,
		'LEPPIMINE': 0.000520461,
		'EBAMUGAVUS': 0.000506546,
		'HOOLETUS': 0.000504178,
		'KIINDUMUS': 0.000502993,
		'IGAVUS': 0.000487303,
		'ALLASURUTUD': 0.000484934,
		'IGATSUS': 0.000475757,
		'JÄRJEKINDEL': 0.000460658,
		'KERGENDATUS': 0.000457105,
		'KOHUSETUNNE': 0.000447336,
		'EMPAATIA': 0.000421579,
		'ENDASSETÕMBUNUD': 0.000402928,
		'KANNATUS': 0.000357039,
		'LEEBE': 0.000350822,
		'KINNINE': 0.000341053,
		'ARGUS': 0.000281842,
		'KOHMETUS': 0.000270296,
		'KAASTUNNE': 0.000230625,
		'HÄBELIK': 0.000189474,
		'LAISK': 0.000166678,
		'ANDESTUS': 0.000132928,
		'HAJEVIL': 0.00011102,
		'LONGUS': 0.000489671,
		'LOOMINGULISUS': 0.068650365,
		'LOOTUS': 0.113051336,
		'LOOTUSETUS': 0.000723553,
		'LUGUPIDAMINE': 0.000653388,
		'LUST': 0.31977511,
		'LÕBU': 0.287901174,
		'LÕDVESTUMINE': 0.000591513,
		'LÕTV': 0.000719408,
		'LÕÕGASTUNUD': 0.000587961,
		'MAHAJÄETUS': 0.000696612,
		'MASENDUS': 0.000804079,
		'MEELDIV': 0.000675,
		'MEELEHEIDE': 0.333302551,
		'MEELEHÄRM': 0.182401817,
		'MEELEKINDLUS': 0.000796678,
		'MEELETU': 0.017441864,
		'MEELTESEGADUS': 0.196659488,
		'MELANHOOLIA': 0.019206168,
		'MUGAV': 0.000487895,
		'MURE': 0.175806539,
		'MURELIK': 0.125383684,
		'MURETU': 0.000714967,
		'MÕNU': 0.000812961,
		'MÕTLIK': 0.000341941,
		'MÕTTETUS': 0.000549474,
		'NAER': 0.235929403,
		'NAERUVÄÄRNE': 0.249859181,
		'NALJAKAS': 0.165515572,
		'NAUDING': 0.155085961,
		'NORMAALNE': 0.00001362,
		'NORUTUNNE': 0.000431053,
		'NOSTALGIA': 0.00055125,
		'NUKRUS': 0.000726513,
		'NUTT': 0.264585687,
		'NÕME': 0.235305613,
		'NÄLG': 0.130540669,
		'NÄRVILISUS': 0.345796754,
		'NÖRDIMUS': 0.000593882,
		'NÜRISTUNUD': 0.000667895,
		'OHJELDAMATU': 0.15413867,
		'OOTUS': 0.217204828,
		'OOTUSÄREVUS': 0.40988883,
		'OPTIMISTLIK': 0.094963933,
		'OSAVÕTLIK': 0.064565094,
		'OTSUSTAV': 0.000384868,
		'PAANIKA': 0.655748059,
		'PABIN': 0.422102819,
		'PAHAMEEL': 0.057874669,
		'PAHANE': 0.109008097,
		'PAHATAHTLIK': 0.229540313,
		'PASSIIVNE': 0.000198947,
		'PEAST': 0.446681988,
		'PELG': 0.016336064,
		'PESSIMISTLIK': 0.00039375,
		'PETTUMUS': 0.082930619,
		'PIIN': 0.362303456,
		'PIINLIKKUS': 0.184072437,
		'PIKALDANE': 0.000344901,
		'PINEV': 0.043057198,
		'PINGE': 0.26191027,
		'PISARAD': 0.118038101,
		'POOLEHOID': 0.053964218,
		'POSITIIVNE': 0.072602638,
		'PUHANUD': 0.000783947,
		'PÕIKPÄINE': 0.116128672,
		'PÕLATUD': 0.033953585,
		'PÕLGUS': 0.226878906,
		'PÕNEVUS': 0.256601676,
		'RAEV': 0.529383835,
		'RAHU': 0.000780691,
		'RAHULIK': 0.000594474,
		'RAHULOLEMATUS': 0.481743673,
		'RAHULOLU': 0.000796086,
		'RAHUTUS': 0.324199356,
		'RASKUS': 0.000372138,
		'REIBAS': 0.166330075,
		'RIIDLEMA': 0.294875577,
		'ROMANTILINE': 0.005175596,
		'RUSUTUD': 0.000680625,
		'RÕÕM': 0.371428398,
		'SALLIMATUS': 0.162049072,
		'SALLIVUS': 0.000548882,
		'SEGADUS': 0.305001344,
		'SIIRAS': 0.000592401,
		'SOLVUMINE': 0.085603318,
		'SOOJUS': 0.000701349,
		'SOOV': 0.082294282,
		'SUNDIMATU': 0.000134408,
		'SÕPRUS': 0.021517934,
		'SÜDAMLIK': 0.000773882,
		'SÜDI': 0.054927402,
		'SÜNGE': 0.000685362,
		'SÜÜ': 0.21607707,
		'SÜÜMEPIIN': 0.273823552,
		'TAHE': 0.119095177,
		'TAHTEKINDLUS': 0.175937654,
		'TASAKAAL': 0.000704013,
		'TEADMATUS': 0.223190117,
		'TERVE': 0.000827467,
		'TIGEDUS': 0.458425886,
		'TOBE': 0.000299309,
		'TOIMEKAS': 0.028034794,
		'TOLERANTSUS': 0.000516316,
		'TRAGI': 0.066956742,
		'TUBLI': 0.057590272,
		'TUGEV': 0.087793798,
		'TUIM': 0.000333355,
		'TUJUTUS': 0.000432829,
		'TUNDEKÜLLANE': 0.166514932,
		'TUNDETU': 0.000413289,
		'TUNDLIK': 0.00005181,
		'TURVALISUS': 0.000726513,
		'TUSK': 0.000675888,
		'TÕSIDUS': 0.00006661,
		'TÄHELEPANELIKKUS': 0.026453885,
		'TÖÖKUS': 0.000531711,
		'TÜDIMUS': 0.000491743,
		'TÜLGASTUS': 0.271954064,
		'TÜLI': 0.501832097,
		'TÜLPINUD': 0.000673224,
		'UHKUS': 0.000315592,
		'UIMANE': 0.000365921,
		'UJE': 0.000189474,
		'ULJAS': 0.062191221,
		'UNI': 0.00004766,
		'USALDAMATUS': 0.312277919,
		'USALDUS': 0.000769441,
		'USK': 0.000362368,
		'UUDISHIMU': 0.177684183,
		'VABADUS': 0.326299707,
		'VAEN': 0.306890489,
		'VAEV': 0.09440936,
		'VAHVA': 0.081953425,
		'VAIKUS': 0.000166678,
		'VAIMUSTUS': 0.226179625,
		'VALLATU': 0.242494569,
		'VALU': 0.401709087,
		'VALVAS': 0.011139138,
		'VAPPER': 0.166314182,
		'VASTIKUS': 0.385585693,
		'VIHA': 0.680107239,
		'VIHKAMINE': 0.589066512,
		'VILETS': 0.000500625,
		'VIMM': 0.270060318,
		'VIRGE': 0.043676596,
		'VISADUS': 0.074854807,
		'VÄGIVALDNE': 0.664665769,
		'VÄIKLUS': 0.000515428,
		'VÄSIMUS': 0.00039227,
		'ÕELUS': 0.178916707,
		'ÕNN': 0.025348294,
		'ÕNNELIK': 0.345851124,
		'ÕNNETU': 0.000726809,
		'ÕNNIS': 0.000624967,
		'ÕRNUS': 0.000689211,
		'ÕUDUS': 0.453658273,
		'ÄGEDUS': 0.292790283,
		'ÄHMIS': 0.262786671,
		'ÄNGISTUS': 0.292543527,
		'ÄRAOLEV': 0.000610616,
		'ÄREVUS': 0.332091357,
		'ÄRKVEL': 0.072023599,
		'ÄRRITUS': 0.310493959,
		'ÜKSILDUS': 0.000801118,
		'ÜKSINDUS': 0.000679737,
		'ÜKSKÕIKSUS': 0.000631184,
		'ÜLEANNETU': 0.043182248,
		'ÜLEMEELIK': 0.125776402,
		'ÜLEV': 0.128145884,
		'ÜLLATUS': 0.287076424
	}

	for key, value in emwords.iteritems():
		keylemma = Text(key).lemmas[0]
		em.insert({
			'word': keylemma,
			'score': value
		})

def map_emwords(obj):
	return

def calculateEmotionalScore():

	emwords = {}

	for em in db.emotionalwords.find():
		emwords[em['word']] = em['score']

	for post in db.post.find():
		score = 0.0

		for key, howmany in post['lemmas'].iteritems():

			if key in emwords:
				score += emwords[key] * howmany

		result = db.post.update_one({
			'_id': post.get('_id')
		}, {
			'$set': {
				'emotionalScore': score / post['wordCount']
			}
		})

		if result.matched_count != 1:
			print 'Failed to save new score'

def doit():
	generateLemmas();
	updateEmotionalWordsToDB();
	calculateEmotionalScore();



doit();

